name: SonarQube
on:
    push:
        branches:
            - main
    pull_request:
        types: [opened, synchronize, reopened]
    workflow_dispatch: # Allows manual triggering
jobs:
    build:
        name: Build and analyze
        runs-on: ubuntu-latest
        environment: unit-test-envt

        services:
            postgres:
                image: postgres:17
                env:
                    POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
                    POSTGRES_USER: ${{ secrets.DATABASE_USERNAME }}
                    POSTGRES_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: 17
                  distribution: "temurin" # Eclipse Temurin distribution
            - name: Cache SonarQube packages
              uses: actions/cache@v4
              with:
                  path: ~/.sonar/cache
                  key: ${{ runner.os }}-sonar
                  restore-keys: ${{ runner.os }}-sonar
            - name: Cache Gradle packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: ${{ runner.os }}-gradle
            - name: Build and analyze
              working-directory: ./core
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Needed for PR decoration
                  SPRING_APP_NAME: core
                  DATABASE_URL: ${{ secrets.DATABASE_URL || 'jdbc:postgresql://localhost:5432/tariff_db' }}
                  DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME || 'admin' }}
                  DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD || 'admin123' }}
                  POSTGRES_DB: ${{ secrets.POSTGRES_DB || 'tariff_db' }}
                  JPA_DDL_AUTO: create-drop
                  JPA_SHOW_SQL: true
                  CORS_ORIGIN: http://localhost:5173
                  HTTPS_ENABLED: false
                  JWT_ISSUER: http://localhost:8080/api/v1/auth
                  JWT_KEY_ID: 6f976ce0-4aad-47d7-a141-b7d40e44ea16
                  JWT_PRIVATE_KEY: ${{ secrets.JWT_PRIVATE_KEY }}
                  JWT_PUBLIC_KEY: ${{ secrets.JWT_PUBLIC_KEY }}
                  JWT_REFRESH_DURATION: 32400
                  JWT_EXPIRATION_TIME: 240
                  PERPLEXITY_KEY: ${{ secrets.PERPLEXITY_KEY }}
              run: |
                  chmod +x gradlew
                  ./gradlew build sonar --info
